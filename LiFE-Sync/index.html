<!DOCTYPE html><html lang="en"><head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    
    <link rel="canonical" href="https://valueerrorx.github.io/personal-wiki/LiFE-Sync/">
    <link rel="shortcut icon" href="../img/favicon.ico">

    
    <title>LiFE-Sync - Personal Wiki</title>
    

    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.12.0/css/all.css">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.12.0/css/v4-shims.css">
    <link rel="stylesheet" href="//cdn.jsdelivr.net/npm/hack-font@3.3.0/build/web/hack.min.css">
    <link href="//rsms.me/inter/inter.css" rel="stylesheet" type="text/css">
    <link href="//fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,700italic,400,300,600,700&amp;subset=latin-ext,latin" rel="stylesheet" type="text/css">
    <link href="../css/bootstrap-custom.min.css" rel="stylesheet">
    <link href="../css/base.min.css" rel="stylesheet">
    <link href="../css/cinder.min.css" rel="stylesheet">

    
        
        <link rel="stylesheet" href="//cdn.jsdelivr.net/gh/highlightjs/cdn-release@9.18.0/build/styles/github.min.css">
        
    

    <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
            <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
            <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
        <![endif]-->

    

     
<link href="../assets/stylesheets/glightbox.min.css" rel="stylesheet"><script src="../assets/javascripts/glightbox.min.js"></script><style id="glightbox-style">
            html.glightbox-open { overflow: initial; height: 100%; }
            .gslide-title { margin-top: 0px; user-select: text; }
            .gslide-desc { color: #666; user-select: text; }
            .gslide-image img { background: white; }
        </style></head>

<body>

    <div class="navbar navbar-default navbar-fixed-top" role="navigation">
    <div class="container">

        <!-- Collapsed navigation -->
        <div class="navbar-header">
            <!-- Expander button -->
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            

            <!-- Main title -->

            
              <a class="navbar-brand" href="..">Personal Wiki</a>
            
        </div>

        <!-- Expanded navigation -->
        <div class="navbar-collapse collapse">
                <!-- Main navigation -->
                <ul class="nav navbar-nav">
                
                
                    <li class="active">
                        <a href="./">LiFE-Sync</a>
                    </li>
                
                
                
                    <li>
                        <a href="../OverlayFS/">OverlayFS</a>
                    </li>
                
                
                </ul>

            <ul class="nav navbar-nav navbar-right">
                    <li class="disabled">
                        <a rel="prev">
                            <i class="fas fa-arrow-left"></i> Previous
                        </a>
                    </li>
                    <li>
                        <a rel="next" href="../OverlayFS/">
                            Next <i class="fas fa-arrow-right"></i>
                        </a>
                    </li>
            </ul>
        </div>
    </div>
</div>

    <div class="container">
        
        
        <div class="col-md-3"><div class="bs-sidebar hidden-print affix well" role="complementary">
    <ul class="nav bs-sidenav">
        <li class="first-level active"><a href="#overlay-cleaner-service-einrichten">(Overlay Cleaner Service einrichten)</a></li>
            <li class="second-level"><a href="#client">Client</a></li>
                
            <li class="second-level"><a href="#1-verzeichnisse-erstellen">1) Verzeichnisse erstellen</a></li>
                
            <li class="second-level"><a href="#2-fetch-service">2) Fetch-Service</a></li>
                
            <li class="second-level"><a href="#3-run-service">3) Run-Service</a></li>
                
            <li class="second-level"><a href="#4-overlay-mount-service">4) Overlay Mount Service</a></li>
                
            <li class="second-level"><a href="#5-aktivierung-der-services">5) Aktivierung der Services</a></li>
                
                <li class="third-level"><a href="#kurzlogik">Kurzlogik:</a></li>
        <li class="first-level "><a href="#_1"></a></li>
        <li class="first-level "><a href="#server">Server</a></li>
            <li class="second-level"><a href="#0-basis">0) Basis</a></li>
                
            <li class="second-level"><a href="#1-user-verzeichnisse">1) User &amp; Verzeichnisse</a></li>
                
            <li class="second-level"><a href="#2-skripte-ablegen">2) Skripte ablegen</a></li>
                
            <li class="second-level"><a href="#3-manifest-erzeugen">3) Manifest erzeugen</a></li>
                
            <li class="second-level"><a href="#4-http-server-als-systemd-service">4) HTTP-Server als systemd-Service</a></li>
                
            <li class="second-level"><a href="#5-service-aktivieren">5) Service aktivieren</a></li>
                
    </ul>
</div></div>
        <div class="col-md-9" role="main">

<h2 id="overlay-cleaner-service-einrichten">(Overlay Cleaner Service einrichten)</h2>
<h3 id="client">Client</h3>
<h3 id="1-verzeichnisse-erstellen">1) Verzeichnisse erstellen</h3>
<pre><code class="language-bash">mkdir -p /var/lib/boot-fetcher/queue /var/lib/boot-fetcher/done /var/lib/boot-fetcher/work
</code></pre>
<h3 id="2-fetch-service">2) Fetch-Service</h3>
<p>(holt Dateien vom http server auf port 8080)</p>
<p><strong>Datei</strong>: <code>/usr/local/bin/boot-fetch.sh</code></p>
<pre><code class="language-bash">`#!/usr/bin/env bash`
`set -euo pipefail                                   # fail fast`
`SERVER_IP="10.40.0.1"                               # &lt;- fixe Server-IP`
`PORT="8080"                                         # &lt;- HTTP-Port`
`REMOTE="queue"                                      # &lt;- Server-Unterordner`
`BASE="http://${SERVER_IP}:${PORT}/${REMOTE}"        # base url`

`STATE="/var/lib/boot-fetcher"                       # state dir`
`QUEUE="${STATE}/queue"                              # queue for scripts`
`WORK="${STATE}/work"                                # temp dir`

`mkdir -p "${QUEUE}" "${WORK}"                       # ensure dirs`

`curl -fsS "${BASE}/scripts.txt" -o "${WORK}/scripts.txt"   # fetch manifest`
`mapfile -t FILES &lt; &lt;(grep -Ev '^\s*$|^\s*#' "${WORK}/scripts.txt" | sort -u)  # parse list`

`for f in "${FILES[@]}"; do`
  `curl -fsS "${BASE}/${f}" -o "${QUEUE}/${f}"      # download each listed file`
  `chmod +x "${QUEUE}/${f}"                         # ensure executable`
`done`
</code></pre>
<p><code>chmod +x /usr/local/bin/boot-fetch.sh</code></p>
<p><strong>Datei</strong>: <code>/etc/systemd/system/boot-fetch.service</code></p>
<pre><code class="language-ini">[Unit]
Description=Fetch boot scripts from server (no execution)
Wants=network-online.target
After=network-online.target

[Service]
Type=oneshot
ExecStart=/usr/local/bin/boot-fetch.sh
TimeoutStartSec=30s                                         
RemainAfterExit=yes

[Install]
WantedBy=multi-user.target
</code></pre>
<h3 id="3-run-service">3) Run-Service</h3>
<p>(führt aus, pflegt „done“, signalisiert Fertig)</p>
<p><strong>Datei</strong>: <code>/usr/local/bin/boot-run.sh</code></p>
<pre><code class="language-bash">#!/usr/bin/env bash
set -euo pipefail                                   # fail fast
STATE="/var/lib/boot-fetcher"                       # state dir
QUEUE="${STATE}/queue"                              # queue with scripts
DONE="${STATE}/done"                                # done dir
STAMP="/run/boot-runner.done"                       # per-boot completion stamp

mkdir -p "${QUEUE}" "${DONE}"                       # ensure dirs
shopt -s nullglob                                   # empty glob -&gt; no iteration

for s in "${QUEUE}"/*.sh; do
  name="$(basename "$s")"                           # script base name
  [[ -e "${DONE}/${name}" ]] &amp;&amp; { rm -f "$s"; continue; }   # skip if already done, clean queue
  if bash "$s"; then                                # execute as root
    mv -f "$s" "${DONE}/${name}"                    # move to done (no duplicate in queue)
  fi
done

touch "${STAMP}"                                    # signal: all done this boot

</code></pre>
<p><code>chmod +x /usr/local/bin/boot-run.sh</code></p>
<p><strong>Datei</strong>: <code>/etc/systemd/system/boot-run.service</code></p>
<pre><code class="language-ini">[Unit]
Description=Execute queued boot scripts and mark them done
Wants=boot-fetch.service
After=boot-fetch.service

[Service]
Type=oneshot
ExecStart=/usr/local/bin/boot-run.sh
RemainAfterExit=yes

[Install]
WantedBy=multi-user.target
</code></pre>
<h3 id="4-overlay-mount-service">4) Overlay Mount Service</h3>
<p>(mounted das overlayFS nach /home/student - nachdem der Run-Service fertig ist. Auf diese Weise können auch im Home Verzeichnis Änderungen durchgeführt werden)</p>
<p><strong>Datei</strong>: <code>/etc/systemd/system/home-student.mount</code></p>
<pre><code class="language-ini">[Unit]
Description=OverlayFS for /home/student
After=overlay-cleaner.service boot-run.service
Requires=overlay-cleaner.service boot-run.service
ConditionPathExists=/run/boot-runner.done
RequiresMountsFor=/mnt/upper /mnt/work

[Mount]
What=overlay
Where=/home/student
Type=overlay
Options=lowerdir=/home/student,upperdir=/mnt/upper,workdir=/mnt/work

[Install]
WantedBy=multi-user.target
</code></pre>
<p><strong>Datei</strong>: <code>/etc/systemd/system/overlay-cleaner.service</code></p>
<pre><code class="language-ini">[Unit]
Description=Delete overlay upper/work before mount
After=local-fs.target
Before=home-student.mount

[Service]
Type=oneshot
ExecStart=/bin/rm -rf /mnt/upper /mnt/work || true
ExecStartPost=/bin/mkdir -p /mnt/upper /mnt/work || true
ExecStartPost=/bin/chown -R student:student /mnt/upper /mnt/work || true
RemainAfterExit=true    

[Install]
WantedBy=home-student.mount
</code></pre>
<h3 id="5-aktivierung-der-services">5) Aktivierung der Services</h3>
<pre><code class="language-bash">systemctl daemon-reload
systemctl enable --now boot-fetch.service
systemctl enable --now boot-run.service
systemctl enable --now overlay-cleaner.service
systemctl enable --now home-student.mount
</code></pre>
<h4 id="kurzlogik">Kurzlogik:</h4>
<p>Fetch holt → 
Run checkt ob Script neu ist →
Run führt aus wenn neu
Run kopiert Script nach ./done &amp; setzt /run/boot-runner.done → 
Overlay mounted - hängt von boot-run.service (und optional dem Stampfile und dem cleaner service)  ab.</p>
<h1 id="_1"><br></h1>
<h1 id="server">Server</h1>
<h3 id="0-basis">0) Basis</h3>
<p>Feste Server-IP notieren (z. B. 10.40.0.1)
Port wählen (z. B. 8080)</p>
<h3 id="1-user-verzeichnisse">1) User &amp; Verzeichnisse</h3>
<pre><code class="language-bash">sudo useradd -r -s /usr/sbin/nologin bootscripts      # system user (no shell)
sudo mkdir -p /srv/bootscripts/queue
sudo chown -R bootscripts:bootscripts /srv/bootscripts
sudo chmod -R 755 /srv/bootscripts
</code></pre>
<h3 id="2-skripte-ablegen">2) Skripte ablegen</h3>
<p><code>cd /srv/bootscripts/queue</code></p>
<p>Beispiel:</p>
<pre><code class="language-bash">sudo printf '#!/usr/bin/env bash\necho hello\n' &gt; 001-init.sh
</code></pre>
<h3 id="3-manifest-erzeugen">3) Manifest erzeugen</h3>
<p>(nur die Skripte die in scripts.txt vermerkt sind werden vom Client auch heruntergeladen und ausgeführt)</p>
<pre><code class="language-bash">cd /srv/bootscripts/queue
ls -1 *.sh 2&gt;/dev/null | sort -V &gt; scripts.txt            # one filename per line
</code></pre>
<h3 id="4-http-server-als-systemd-service">4) HTTP-Server als systemd-Service</h3>
<p><strong>Datei:</strong> <code>/etc/systemd/system/bootscripts-http.service</code></p>
<pre><code class="language-ini">[Unit]
Description=Serve /srv/bootscripts via Python HTTP
After=network-online.target
Wants=network-online.target

[Service]
Type=simple
User=bootscripts
Group=bootscripts
WorkingDirectory=/srv/bootscripts
ExecStart=/usr/bin/python3 -m http.server 8080 --bind 0.0.0.0
Restart=on-failure
NoNewPrivileges=true
PrivateTmp=true
ProtectSystem=full
ProtectHome=true

[Install]
WantedBy=multi-user.target
</code></pre>
<h3 id="5-service-aktivieren">5) Service aktivieren</h3>
<pre><code class="language-bash">sudo systemctl daemon-reload
sudo systemctl enable --now bootscripts-http.service
</code></pre></div>
        
        
    </div>

    
      <footer class="col-md-12 text-center">
          
          
            <hr>
            <p>
            <small>Documentation built with <a href="http://www.mkdocs.org/">MkDocs</a>.</small>
            </p>
          

          
          
      </footer>
    
    <script src="//ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
    <script src="../js/bootstrap-3.0.3.min.js"></script>

    
    <script src="//cdn.jsdelivr.net/gh/highlightjs/cdn-release@9.18.0/build/highlight.min.js"></script>
        
    <script>hljs.initHighlightingOnLoad();</script>
    

    <script>var base_url = ".."</script>
    
    <script src="../js/base.js"></script>

    <div class="modal" id="mkdocs_keyboard_modal" tabindex="-1" role="dialog" aria-labelledby="keyboardModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="keyboardModalLabel">Keyboard Shortcuts</h4>
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">×</span><span class="sr-only">Close</span></button>
            </div>
            <div class="modal-body">
              <table class="table">
                <thead>
                  <tr>
                    <th style="width: 20%;">Keys</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td class="help shortcut"><kbd>?</kbd></td>
                    <td>Open this help</td>
                  </tr>
                  <tr>
                    <td class="next shortcut"><kbd>n</kbd></td>
                    <td>Next page</td>
                  </tr>
                  <tr>
                    <td class="prev shortcut"><kbd>p</kbd></td>
                    <td>Previous page</td>
                  </tr>
                  <tr>
                    <td class="search shortcut"><kbd>s</kbd></td>
                    <td>Search</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>
    


<script id="init-glightbox">const lightbox = GLightbox({"touchNavigation": true, "loop": false, "zoomable": true, "draggable": true, "openEffect": "zoom", "closeEffect": "zoom", "slideEffect": "slide"});
</script></body></html>